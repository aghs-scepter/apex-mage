{"id":"apex-mage-0kz","title":"Epic 8: HTTP API Layer for Web UI","description":"Create a FastAPI backend exposing core operations so a TypeScript web UI can mirror Discord conversations. Includes auth, session management, and real-time sync.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T02:10:39.541754-05:00","updated_at":"2025-12-15T11:22:54.469786-05:00","closed_at":"2025-12-15T11:22:54.469786-05:00"}
{"id":"apex-mage-1g3","title":"Consolidate duplicated Discord command code","description":"~120 lines duplicated between chat.py and image.py:\n1. count_command decorator (35 lines each)\n2. handle_text_overflow function (25 lines each)\n3. _create_embed_user helper (7 lines each)\nFix:\n1. Create src/clients/discord/utils.py with shared functions\n2. Move count_command to decorators.py with shared counter\n3. Update imports in chat.py and image.py\nAddresses: C5-1, C5-2, C5-3","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.272229-05:00","updated_at":"2025-12-18T16:18:50.272229-05:00"}
{"id":"apex-mage-1ht","title":"Improve error classification and handling","description":"Distinguish transient errors (rate limits, timeouts) from permanent errors (invalid input, auth failures). Add retry logic for transient errors. Log with appropriate severity levels.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:02.607155-05:00","updated_at":"2025-12-15T11:00:21.559162-05:00","closed_at":"2025-12-15T11:00:21.559162-05:00"}
{"id":"apex-mage-1vd","title":"Epic 9: Code Quality Remediation from Epics 1-8 Review","description":"Remediation epic addressing findings from comprehensive code review of Epics 1-8. Contains 1 Critical, 18 Major issues identified across 8 review chunks.","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-18T16:18:08.809146-05:00","updated_at":"2025-12-18T16:18:08.809146-05:00"}
{"id":"apex-mage-1w4","title":"2.3 Implement AnthropicProvider","description":"## Current State\nai.py has Anthropic client created at module load.\n\n## Implementation Steps\n1. Create `src/providers/anthropic_provider.py`\n\n2. Implement AnthropicProvider class:\n   ```python\n   from anthropic import AsyncAnthropic\n   \n   class AnthropicProvider:\n       def __init__(self, api_key: str, default_model: str = \"claude-3-sonnet\"):\n           self._client = AsyncAnthropic(api_key=api_key)\n           self._default_model = default_model\n       \n       async def chat(self, messages, system_prompt, max_tokens) -\u003e ChatResponse:\n           # Convert ChatMessage to Anthropic format\n           # Call API\n           # Convert response to ChatResponse\n           ...\n       \n       async def chat_stream(self, messages, system_prompt) -\u003e AsyncIterator[str]:\n           # Streaming implementation\n           ...\n   ```\n\n3. Migrate existing Anthropic code from ai.py:\n   - Preserve error handling\n   - Preserve retry logic if any\n   - Handle rate limits appropriately\n\n## Acceptance Criteria\n- [ ] Class implements AIProvider Protocol\n- [ ] API key is injected, not from environment directly\n- [ ] Existing Anthropic functionality preserved\n- [ ] Proper error handling for API failures","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:41.020725-05:00","updated_at":"2025-12-14T23:57:53.252937-05:00","closed_at":"2025-12-14T23:57:53.252937-05:00","dependencies":[{"issue_id":"apex-mage-1w4","depends_on_id":"apex-mage-n7n","type":"blocks","created_at":"2025-12-14T22:56:33.295135-05:00","created_by":"daemon"}]}
{"id":"apex-mage-2fp","title":"Fix FalAIProvider environment variable and retry handling","description":"FalAIProvider has two issues:\n1. Sets FAL_KEY env var in constructor (global state mutation)\n2. No retry logic for transient errors (unlike AnthropicProvider)\nFix:\n1. Check if fal_client supports direct API key passing, or document limitation\n2. Add retry logic using src/core/errors.retry_with_backoff\n3. Integrate FalAIError with error classification system\nAddresses: C2-1, C2-2","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.090565-05:00","updated_at":"2025-12-18T16:18:50.090565-05:00"}
{"id":"apex-mage-35a","title":"3.4 Integrate core logic into handlers","description":"## Current State\nCore logic extracted, handlers still use old inline logic.\n\n## Implementation Steps\n1. Update command handlers to use ContextBuilder:\n   ```python\n   async def handle_chat(interaction, message, context_builder, ai_provider, repo):\n       history = await repo.get_context(interaction.channel_id, limit=100)\n       context = context_builder.build_context(history)\n       response = await ai_provider.chat(context.messages)\n       ...\n   ```\n\n2. Update handlers to use RateLimiter:\n   ```python\n   async def handle_chat(interaction, ..., rate_limiter):\n       result = await rate_limiter.check(interaction.user.id, \"chat\")\n       if not result.allowed:\n           await interaction.response.send_message(\n               f\"Rate limited. Try again in {result.wait_seconds}s\"\n           )\n           return\n       ...\n   ```\n\n3. Inject dependencies through bot setup\n\n## Acceptance Criteria\n- [ ] Handlers use ContextBuilder\n- [ ] Handlers use RateLimiter\n- [ ] Old inline logic removed\n- [ ] All commands work correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:27.822329-05:00","updated_at":"2025-12-15T01:33:36.221852-05:00","closed_at":"2025-12-15T01:33:36.221852-05:00","dependencies":[{"issue_id":"apex-mage-35a","depends_on_id":"apex-mage-c5n","type":"blocks","created_at":"2025-12-14T22:56:36.947761-05:00","created_by":"daemon"},{"issue_id":"apex-mage-35a","depends_on_id":"apex-mage-rr4","type":"blocks","created_at":"2025-12-14T22:56:36.991052-05:00","created_by":"daemon"},{"issue_id":"apex-mage-35a","depends_on_id":"apex-mage-8hq","type":"blocks","created_at":"2025-12-14T22:56:37.034669-05:00","created_by":"daemon"},{"issue_id":"apex-mage-35a","depends_on_id":"apex-mage-hgh","type":"blocks","created_at":"2025-12-14T22:56:37.078631-05:00","created_by":"daemon"}]}
{"id":"apex-mage-3ez","title":"Implement image generation API endpoints","description":"Create REST endpoints for: POST /images/generate, POST /images/modify. Handle async generation with status polling or webhooks. Return GCS URLs for generated images.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:13.351804-05:00","updated_at":"2025-12-15T11:18:30.195331-05:00","closed_at":"2025-12-15T11:18:30.195331-05:00","dependencies":[{"issue_id":"apex-mage-3ez","depends_on_id":"apex-mage-jrs","type":"blocks","created_at":"2025-12-15T02:12:34.385885-05:00","created_by":"daemon"}]}
{"id":"apex-mage-41f","title":"Add API authentication","description":"Implement JWT-based authentication for the HTTP API. Create login/register endpoints or integrate with external auth provider. Add middleware to protect conversation endpoints.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:13.496458-05:00","updated_at":"2025-12-15T11:20:47.638897-05:00","closed_at":"2025-12-15T11:20:47.638897-05:00","dependencies":[{"issue_id":"apex-mage-41f","depends_on_id":"apex-mage-jrs","type":"blocks","created_at":"2025-12-15T02:12:34.429357-05:00","created_by":"daemon"}]}
{"id":"apex-mage-45f","title":"5.2 Separate carousel view from business logic","description":"## Current State\ncarousel.py (809 lines) mixes Discord UI components with business logic.\n\n## Implementation Steps\n1. Analyze carousel.py to identify:\n   - Pure UI code (Views, Buttons, Modals)\n   - Business logic (image selection, pagination state)\n   - Data fetching (should use repositories)\n\n2. Create `src/core/carousel_logic.py`:\n   ```python\n   @dataclass\n   class CarouselState:\n       items: list[Any]\n       current_index: int\n       page_size: int\n   \n   class CarouselController:\n       def next_page(self, state: CarouselState) -\u003e CarouselState: ...\n       def prev_page(self, state: CarouselState) -\u003e CarouselState: ...\n       def select_item(self, state: CarouselState, index: int) -\u003e Any: ...\n   ```\n\n3. Keep Discord UI in `src/clients/discord/views/carousel.py`:\n   - Views reference CarouselController\n   - UI code is thin layer over business logic\n\n4. Add tests for CarouselController\n\n## Acceptance Criteria\n- [ ] Business logic extracted from carousel.py\n- [ ] CarouselController is testable without Discord\n- [ ] Discord views are thin UI layer\n- [ ] Tests for carousel business logic","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:59.330888-05:00","updated_at":"2025-12-15T01:37:17.193518-05:00","closed_at":"2025-12-15T01:37:17.193518-05:00","dependencies":[{"issue_id":"apex-mage-45f","depends_on_id":"apex-mage-35a","type":"blocks","created_at":"2025-12-14T22:56:43.974045-05:00","created_by":"daemon"}]}
{"id":"apex-mage-4r2","title":"2.2 Create ImageProvider Protocol","description":"## Current State\nai.py has Fal.AI integration for image generation.\n\n## Implementation Steps\n1. Add to `src/core/providers.py`\n\n2. Define ImageProvider Protocol:\n   ```python\n   @dataclass\n   class ImageRequest:\n       prompt: str\n       negative_prompt: str | None = None\n       width: int = 1024\n       height: int = 1024\n       num_images: int = 1\n   \n   @dataclass\n   class GeneratedImage:\n       url: str\n       width: int\n       height: int\n       seed: int | None = None\n   \n   class ImageProvider(Protocol):\n       async def generate(\n           self,\n           request: ImageRequest,\n       ) -\u003e list[GeneratedImage]: ...\n       \n       async def get_models(self) -\u003e list[str]: ...\n   ```\n\n3. Review ai.py Fal.AI code to ensure all operations captured\n\n## Acceptance Criteria\n- [ ] Protocol defined for image generation\n- [ ] Request/response dataclasses defined\n- [ ] Supports multiple images per request\n- [ ] No vendor-specific types in protocol","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:40.8858-05:00","updated_at":"2025-12-14T23:53:19.369513-05:00","closed_at":"2025-12-14T23:53:19.369513-05:00"}
{"id":"apex-mage-56q","title":"2.5 Create mock providers for testing","description":"## Current State\nNo way to test code that uses AI/Image providers without real API calls.\n\n## Implementation Steps\n1. Create `tests/mocks/providers.py`\n\n2. Implement MockAIProvider:\n   ```python\n   class MockAIProvider:\n       def __init__(self, responses: list[str] | None = None):\n           self.responses = responses or [\"Mock response\"]\n           self.call_count = 0\n           self.last_messages = None\n       \n       async def chat(self, messages, system_prompt, max_tokens) -\u003e ChatResponse:\n           self.call_count += 1\n           self.last_messages = messages\n           return ChatResponse(\n               content=self.responses[self.call_count - 1],\n               model=\"mock-model\",\n               usage={\"input_tokens\": 10, \"output_tokens\": 20}\n           )\n   ```\n\n3. Implement MockImageProvider similarly\n\n4. Add fixtures to conftest.py for easy test access\n\n## Acceptance Criteria\n- [ ] MockAIProvider implements AIProvider Protocol\n- [ ] MockImageProvider implements ImageProvider Protocol\n- [ ] Mocks record calls for assertions\n- [ ] Mocks support configurable responses\n- [ ] Available as pytest fixtures","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:41.298139-05:00","updated_at":"2025-12-15T01:00:51.997236-05:00","closed_at":"2025-12-15T01:00:51.997236-05:00","dependencies":[{"issue_id":"apex-mage-56q","depends_on_id":"apex-mage-n7n","type":"blocks","created_at":"2025-12-14T22:56:33.384652-05:00","created_by":"daemon"},{"issue_id":"apex-mage-56q","depends_on_id":"apex-mage-4r2","type":"blocks","created_at":"2025-12-14T22:56:33.428997-05:00","created_by":"daemon"},{"issue_id":"apex-mage-56q","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:33.471971-05:00","created_by":"daemon"}]}
{"id":"apex-mage-5hs","title":"Add in-memory command counter with decorator","description":"Add an in-memory command counter using a decorator pattern. Each slash command invocation logs at INFO level with format: Command '\u003cname\u003e' invoked. Count: \u003cn\u003e. Counter resets on bot restart.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-14T22:03:34.257815-05:00","updated_at":"2025-12-14T22:09:01.409594-05:00","closed_at":"2025-12-14T22:09:01.409594-05:00"}
{"id":"apex-mage-5q8","title":"5.3 Organize Discord client structure","description":"## Current State\nDiscord code is in main.py and carousel.py at root level.\n\n## Implementation Steps\n1. Create proper package structure:\n   ```\n   src/\n     clients/\n       discord/\n         __init__.py\n         bot.py           # Bot setup, lifecycle\n         commands/\n           __init__.py\n           chat.py        # Chat commands\n           image.py       # Image commands\n           admin.py       # Admin commands\n         views/\n           __init__.py\n           carousel.py    # Carousel UI components\n         decorators.py    # Command decorators\n   ```\n\n2. Move and refactor existing code:\n   - Extract bot setup from main.py to bot.py\n   - Group commands by domain\n   - Keep main.py as thin entry point\n\n3. Update imports throughout codebase\n\n## Acceptance Criteria\n- [ ] Discord code organized in src/clients/discord/\n- [ ] Commands grouped by domain\n- [ ] main.py is thin entry point\n- [ ] All imports updated and working","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:59.466264-05:00","updated_at":"2025-12-15T01:43:33.56713-05:00","closed_at":"2025-12-15T01:43:33.56713-05:00","dependencies":[{"issue_id":"apex-mage-5q8","depends_on_id":"apex-mage-pcr","type":"blocks","created_at":"2025-12-14T22:56:44.067294-05:00","created_by":"daemon"},{"issue_id":"apex-mage-5q8","depends_on_id":"apex-mage-45f","type":"blocks","created_at":"2025-12-14T22:56:44.112266-05:00","created_by":"daemon"}]}
{"id":"apex-mage-5sg","title":"1.0 Repository Layer Epic","description":"## Overview\nRefactor mem.py to use a clean repository pattern with protocols for testability.\n\n## Goals\n- Define MessageRepository Protocol with clear interface\n- Implement SQLite adapter conforming to the protocol\n- Establish pytest infrastructure\n- Achieve test coverage for repository layer\n\n## Acceptance Criteria\n- [ ] MessageRepository Protocol defined\n- [ ] SQLiteMessageRepository implements protocol\n- [ ] pytest infrastructure in place\n- [ ] Repository tests passing with \u003e80% coverage","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-14T22:52:31.006211-05:00","updated_at":"2025-12-14T23:46:43.918091-05:00","closed_at":"2025-12-14T23:46:43.918091-05:00"}
{"id":"apex-mage-5vw","title":"5.0 Discord Layer Cleanup Epic","description":"## Overview\nClean up Discord-specific code to reduce boilerplate and separate concerns.\n\n## Goals\n- Extract common command handler patterns into decorators\n- Separate view/UI logic from business logic in carousel.py\n- Improve testability of Discord layer\n\n## Acceptance Criteria\n- [ ] Command boilerplate extracted to decorators/utilities\n- [ ] carousel.py view logic separated from business logic\n- [ ] Discord layer is thin adapter over core logic","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-14T22:52:41.436659-05:00","updated_at":"2025-12-15T01:43:48.750965-05:00","closed_at":"2025-12-15T01:43:48.750965-05:00"}
{"id":"apex-mage-5zl","title":"4.1 Create GitHub Actions CI workflow","description":"## Current State\nNo CI/CD pipeline exists.\n\n## Implementation Steps\n1. Create `.github/workflows/ci.yml`:\n   ```yaml\n   name: CI\n   on:\n     push:\n       branches: [main]\n     pull_request:\n       branches: [main]\n   \n   jobs:\n     lint:\n       runs-on: ubuntu-latest\n       steps:\n         - uses: actions/checkout@v4\n         - uses: actions/setup-python@v5\n           with:\n             python-version: '3.11'\n         - run: pip install ruff\n         - run: ruff check src/\n     \n     typecheck:\n       runs-on: ubuntu-latest\n       steps:\n         - uses: actions/checkout@v4\n         - uses: actions/setup-python@v5\n         - run: pip install mypy\n         - run: mypy src/\n     \n     test:\n       runs-on: ubuntu-latest\n       steps:\n         - uses: actions/checkout@v4\n         - uses: actions/setup-python@v5\n         - run: pip install -r requirements.txt\n         - run: pip install pytest pytest-cov pytest-asyncio\n         - run: pytest --cov=src --cov-report=xml\n         - uses: codecov/codecov-action@v4  # Optional\n   ```\n\n2. Add branch protection rules (documented, manual step)\n\n## Acceptance Criteria\n- [ ] Workflow file created\n- [ ] Lint job runs ruff\n- [ ] Type check job runs mypy\n- [ ] Test job runs pytest with coverage\n- [ ] Workflow triggers on push and PR","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:58.77718-05:00","updated_at":"2025-12-15T01:26:34.591996-05:00","closed_at":"2025-12-15T01:26:34.591996-05:00","dependencies":[{"issue_id":"apex-mage-5zl","depends_on_id":"apex-mage-o50","type":"blocks","created_at":"2025-12-14T22:56:39.425772-05:00","created_by":"daemon"},{"issue_id":"apex-mage-5zl","depends_on_id":"apex-mage-mj7","type":"blocks","created_at":"2025-12-14T22:56:39.473082-05:00","created_by":"daemon"},{"issue_id":"apex-mage-5zl","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:39.516274-05:00","created_by":"daemon"}]}
{"id":"apex-mage-68u","title":"Implement conversation API endpoints","description":"Create REST endpoints for: POST /conversations (start), POST /conversations/{id}/messages (continue), GET /conversations/{id} (retrieve history). Use core business logic from src/core/.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:13.210144-05:00","updated_at":"2025-12-15T11:15:57.611541-05:00","closed_at":"2025-12-15T11:15:57.611541-05:00","dependencies":[{"issue_id":"apex-mage-68u","depends_on_id":"apex-mage-jrs","type":"blocks","created_at":"2025-12-15T02:12:34.340443-05:00","created_by":"daemon"}]}
{"id":"apex-mage-6qp","title":"2.0 AI Provider Layer Epic","description":"## Overview\nRefactor ai.py to use provider protocols for testability and swappable implementations.\n\n## Goals\n- Define AIProvider and ImageProvider protocols\n- Implement adapters for Anthropic and FalAI\n- Create mock providers for testing\n- Enable dependency injection of providers\n\n## Acceptance Criteria\n- [ ] AIProvider Protocol defined\n- [ ] ImageProvider Protocol defined\n- [ ] AnthropicProvider implements AIProvider\n- [ ] FalAIProvider implements ImageProvider\n- [ ] Mock providers available for tests\n- [ ] Provider tests passing","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-14T22:52:31.152782-05:00","updated_at":"2025-12-15T01:43:48.749584-05:00","closed_at":"2025-12-15T01:43:48.749584-05:00"}
{"id":"apex-mage-716","title":"Add correlation IDs for request tracking","description":"Generate unique request IDs at entry points (Discord commands, future HTTP endpoints). Propagate through all log calls to enable tracing a request through the system.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:02.469501-05:00","updated_at":"2025-12-15T10:57:15.572052-05:00","closed_at":"2025-12-15T10:57:15.572052-05:00","dependencies":[{"issue_id":"apex-mage-716","depends_on_id":"apex-mage-9ym","type":"blocks","created_at":"2025-12-15T02:12:31.542133-05:00","created_by":"daemon"}]}
{"id":"apex-mage-7il","title":"2.4 Implement FalAIProvider","description":"## Current State\nai.py has Fal.AI client for image generation.\n\n## Implementation Steps\n1. Create `src/providers/fal_provider.py`\n\n2. Implement FalAIProvider class:\n   ```python\n   class FalAIProvider:\n       def __init__(self, api_key: str):\n           self._api_key = api_key\n       \n       async def generate(self, request: ImageRequest) -\u003e list[GeneratedImage]:\n           # Convert request to Fal.AI format\n           # Call API\n           # Convert response to GeneratedImage list\n           ...\n       \n       async def get_models(self) -\u003e list[str]:\n           # Return supported model list\n           ...\n   ```\n\n3. Migrate existing Fal.AI code from ai.py\n\n## Acceptance Criteria\n- [ ] Class implements ImageProvider Protocol\n- [ ] API key is injected\n- [ ] Existing image generation functionality preserved\n- [ ] Handles Fal.AI specific errors gracefully","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:41.157796-05:00","updated_at":"2025-12-15T00:55:27.121276-05:00","closed_at":"2025-12-15T00:55:27.121276-05:00","dependencies":[{"issue_id":"apex-mage-7il","depends_on_id":"apex-mage-4r2","type":"blocks","created_at":"2025-12-14T22:56:33.340226-05:00","created_by":"daemon"}]}
{"id":"apex-mage-7mo","title":"1.4 Add repository unit tests","description":"## Current State\nSQLiteMessageRepository implemented but untested.\n\n## Implementation Steps\n1. Create `tests/unit/test_sqlite_repository.py`\n\n2. Write tests for each repository method:\n   - Test save_message creates record\n   - Test get_context returns messages in order\n   - Test get_context respects limit\n   - Test get_user_messages filters correctly\n   - Test error handling for invalid inputs\n\n3. Use in-memory SQLite for fast tests:\n   ```python\n   @pytest.fixture\n   async def repository():\n       repo = SQLiteMessageRepository(\":memory:\")\n       await repo.connect()\n       await repo.initialize_schema()\n       yield repo\n       await repo.close()\n   ```\n\n4. Test edge cases:\n   - Empty database\n   - Non-existent channel/user\n   - Large message content\n\n## Acceptance Criteria\n- [ ] All repository methods have tests\n- [ ] Tests use in-memory database\n- [ ] Edge cases covered\n- [ ] \u003e80% coverage on repository module","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:10.262023-05:00","updated_at":"2025-12-14T23:15:35.105316-05:00","closed_at":"2025-12-14T23:15:35.105316-05:00","dependencies":[{"issue_id":"apex-mage-7mo","depends_on_id":"apex-mage-vx5","type":"blocks","created_at":"2025-12-14T22:56:29.999318-05:00","created_by":"daemon"},{"issue_id":"apex-mage-7mo","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:30.044882-05:00","created_by":"daemon"}]}
{"id":"apex-mage-8hq","title":"1.5 Integrate repository into main.py","description":"## Current State\nmain.py imports mem.py functions directly.\n\n## Implementation Steps\n1. Create application bootstrap/factory:\n   ```python\n   # src/app.py or main.py\n   async def create_app() -\u003e tuple[Bot, MessageRepository]:\n       repo = SQLiteMessageRepository(DB_PATH)\n       await repo.connect()\n       bot = create_bot(repository=repo)\n       return bot, repo\n   ```\n\n2. Update command handlers to use injected repository:\n   - Pass repository to handlers that need it\n   - Remove direct mem.py imports from handlers\n\n3. Update bot lifecycle:\n   - Initialize repository on startup\n   - Close repository on shutdown\n\n4. Verify existing functionality works unchanged\n\n## Acceptance Criteria\n- [ ] Repository is injected, not imported globally\n- [ ] Bot startup initializes repository\n- [ ] Bot shutdown cleans up repository\n- [ ] All existing commands work correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:10.399489-05:00","updated_at":"2025-12-14T23:45:57.796101-05:00","closed_at":"2025-12-14T23:45:57.796101-05:00","dependencies":[{"issue_id":"apex-mage-8hq","depends_on_id":"apex-mage-vx5","type":"blocks","created_at":"2025-12-14T22:56:30.089395-05:00","created_by":"daemon"}]}
{"id":"apex-mage-90d","title":"Update Discord commands to use repositories","description":"Replace mem.get_images(), mem.get_channel_latest_image_indicator(), and other mem.* calls with SQLiteRepository methods injected through DiscordBot.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.742219-05:00","updated_at":"2025-12-15T10:41:47.728291-05:00","closed_at":"2025-12-15T10:41:47.728291-05:00"}
{"id":"apex-mage-9mx","title":"Epic 6: Complete Discord Layer Decoupling","description":"Migrate remaining ai.py and mem.py functions to the new architecture so Discord client only uses src/ modules. This unblocks deletion of legacy files and enables web UI development.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T02:10:39.281805-05:00","updated_at":"2025-12-15T10:46:40.390698-05:00","closed_at":"2025-12-15T10:46:40.390698-05:00"}
{"id":"apex-mage-9qy","title":"Remove or integrate unused Discord modules","description":"Two modules exist but are unused:\n1. decorators.py - handle_errors and log_command exported but never used\n2. carousel_logic.py - CarouselController/CarouselState tested but not integrated\nOptions:\nA. Integrate into actual code (use decorators, refactor carousel view)\nB. Remove as dead code\nRecommend: Option A for decorators (use for count_command), Option B for carousel_logic\nAddresses: C5-4, C5-5","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.442853-05:00","updated_at":"2025-12-18T16:18:50.442853-05:00"}
{"id":"apex-mage-9ym","title":"Add structured logging with structlog","description":"Replace standard logging with structlog for JSON-formatted output. Configure for both development (pretty) and production (JSON) modes. Update all logger calls to use structured key-value pairs.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:02.338397-05:00","updated_at":"2025-12-15T10:56:22.172439-05:00","closed_at":"2025-12-15T10:56:22.172439-05:00"}
{"id":"apex-mage-aca","title":"Delete legacy ai.py and mem.py","description":"After all migrations complete, delete ai.py and mem.py from root. Verify no imports remain. Update any documentation references.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.891158-05:00","updated_at":"2025-12-15T10:46:35.320217-05:00","closed_at":"2025-12-15T10:46:35.320217-05:00","dependencies":[{"issue_id":"apex-mage-aca","depends_on_id":"apex-mage-wto","type":"blocks","created_at":"2025-12-15T02:12:25.406895-05:00","created_by":"daemon"},{"issue_id":"apex-mage-aca","depends_on_id":"apex-mage-lvg","type":"blocks","created_at":"2025-12-15T02:12:25.452871-05:00","created_by":"daemon"},{"issue_id":"apex-mage-aca","depends_on_id":"apex-mage-mc4","type":"blocks","created_at":"2025-12-15T02:12:25.496936-05:00","created_by":"daemon"},{"issue_id":"apex-mage-aca","depends_on_id":"apex-mage-h1z","type":"blocks","created_at":"2025-12-15T02:12:25.541665-05:00","created_by":"daemon"},{"issue_id":"apex-mage-aca","depends_on_id":"apex-mage-90d","type":"blocks","created_at":"2025-12-15T02:12:25.583661-05:00","created_by":"daemon"}]}
{"id":"apex-mage-act","title":"1.1 Set up pytest infrastructure","description":"## Current State\nNo test infrastructure exists. Need to establish pytest with proper configuration.\n\n## Implementation Steps\n1. Create `tests/` directory structure:\n   - `tests/__init__.py`\n   - `tests/conftest.py` (shared fixtures)\n   - `tests/unit/` (unit tests)\n   - `tests/integration/` (integration tests)\n\n2. Add pytest configuration to `pyproject.toml` or create `pytest.ini`:\n   - Configure test discovery\n   - Set up coverage reporting\n   - Configure async test support (pytest-asyncio)\n\n3. Add test dependencies:\n   - pytest\n   - pytest-asyncio\n   - pytest-cov\n   - Update requirements.txt or pyproject.toml\n\n4. Create initial smoke test to verify infrastructure works\n\n## Acceptance Criteria\n- [ ] `pytest` command runs successfully\n- [ ] Coverage reporting works\n- [ ] Async test support configured\n- [ ] At least one passing test exists","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:53:08.093197-05:00","updated_at":"2025-12-14T22:59:58.702589-05:00","closed_at":"2025-12-14T22:59:58.702589-05:00"}
{"id":"apex-mage-aga","title":"Epic 7: Observability Improvements","description":"Add structured logging, metrics, error classification, and request tracing to improve production debugging and monitoring capabilities.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T02:10:39.412233-05:00","updated_at":"2025-12-15T11:08:09.549296-05:00","closed_at":"2025-12-15T11:08:09.549296-05:00"}
{"id":"apex-mage-bkv","title":"Define async repository protocols","description":"Repository protocols define sync methods but implementations are async, breaking structural typing.\nOptions:\n1. Create AsyncChannelRepository, AsyncVendorRepository, etc. with async def methods\n2. Use Awaitable[T] return types in current protocols\n3. Document that protocols are for documentation only\nRecommend: Option 1 for type safety with mypy.\nAlso parameterize vendor names in rate limit queries (currently hardcoded Anthropic/Fal.AI).\nAddresses: C1-1, C1-2","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.988118-05:00","updated_at":"2025-12-18T16:18:50.988118-05:00"}
{"id":"apex-mage-bq7","title":"Add authentication to API endpoints","description":"Conversation and image endpoints lack authentication despite auth infrastructure existing.\n1. Add get_current_user dependency to conversation endpoints\n2. Add get_current_user dependency to image endpoints\n3. Replace hardcoded user_id=0 with authenticated user\n4. Fail fast on missing JWT_SECRET_KEY in production\nAddresses: C8-1, C8-6","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:49.91522-05:00","updated_at":"2025-12-18T16:18:49.91522-05:00"}
{"id":"apex-mage-c5n","title":"3.1 Extract conversation context logic","description":"## Current State\nConversation windowing and formatting logic is embedded in command handlers.\n\n## Implementation Steps\n1. Create `src/core/conversation.py`\n\n2. Extract context windowing logic:\n   ```python\n   @dataclass\n   class ConversationContext:\n       messages: list[ChatMessage]\n       total_tokens_estimate: int\n   \n   class ContextBuilder:\n       def __init__(self, max_messages: int = 50, max_tokens: int = 100000):\n           self.max_messages = max_messages\n           self.max_tokens = max_tokens\n       \n       def build_context(\n           self,\n           history: list[Message],\n           system_prompt: str | None = None,\n       ) -\u003e ConversationContext:\n           # Window messages to fit limits\n           # Format for AI provider\n           ...\n   ```\n\n3. Extract message formatting:\n   - User message formatting\n   - Assistant response formatting\n   - System prompt handling\n\n4. This is pure logic - no I/O, easily testable\n\n## Acceptance Criteria\n- [ ] Context windowing extracted to standalone class\n- [ ] Message formatting extracted\n- [ ] No I/O dependencies\n- [ ] Clear interface for building conversation context","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:02.715722-05:00","updated_at":"2025-12-15T01:32:59.289067-05:00","closed_at":"2025-12-15T01:32:59.289067-05:00"}
{"id":"apex-mage-dmj","title":"Add WebSocket support for real-time sync","description":"Implement WebSocket endpoint for real-time conversation updates. When a message is sent via Discord, push to connected web clients. Enable bidirectional sync between platforms.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:13.640075-05:00","updated_at":"2025-12-15T11:22:48.040856-05:00","closed_at":"2025-12-15T11:22:48.040856-05:00","dependencies":[{"issue_id":"apex-mage-dmj","depends_on_id":"apex-mage-68u","type":"blocks","created_at":"2025-12-15T02:12:34.472448-05:00","created_by":"daemon"}]}
{"id":"apex-mage-dup","title":"3.0 Core Business Logic Epic","description":"## Overview\nExtract and test core business logic that is currently entangled with I/O operations.\n\n## Goals\n- Extract conversation context windowing logic\n- Extract message formatting logic\n- Extract rate limiting as standalone component\n- Achieve high test coverage on pure business logic\n\n## Acceptance Criteria\n- [ ] Conversation context logic extracted and tested\n- [ ] Rate limiting logic extracted and tested\n- [ ] Business logic has no direct I/O dependencies\n- [ ] \u003e80% test coverage on core module","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-14T22:52:41.162233-05:00","updated_at":"2025-12-15T01:43:48.75015-05:00","closed_at":"2025-12-15T01:43:48.75015-05:00"}
{"id":"apex-mage-evq","title":"Fix compress_image upscaling bug","description":"compress_image() upscales small images instead of leaving them at original size.\nA 10x10 image becomes 512x512 with default max_size, increasing file size 10x.\nFix in src/core/image_utils.py:68-69:\n```python\n# Change:\nratio = min(max_size[0] / img.size[0], max_size[1] / img.size[1])\n# To:\nratio = min(max_size[0] / img.size[0], max_size[1] / img.size[1], 1.0)\n```\nAlso add test for small image behavior.\nAddresses: C6-1\n\n---\n## Implementation Summary (added by coding agent)\n\n### What Was Built\nFixed the compress_image() function to prevent upscaling small images. Previously, a 10x10 pixel image would be scaled up to 512x512 when passed with the default max_size parameter. Now small images retain their original dimensions.\n\n### Files Changed\n- `src/core/image_utils.py` - Added 1.0 cap to ratio calculation on line 72\n- `tests/unit/test_image_utils.py` - Added test_does_not_upscale_small_images test\n\n### Key Decisions\n- Used comment to explain why 1.0 cap exists for future maintainers\n\n### Deviations from Plan\n- None\n\n### Testing\n- Added test_does_not_upscale_small_images() that creates 10x10 PNG, compresses it, and verifies dimensions remain 10x10\n- All 359 tests pass (was 358, +1 new test)\n- ruff check passes\n\n### Notes for Reviewer\n- Single-line fix with clear comment explaining intent\n- Test is comprehensive and directly verifies the fix","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.795881-05:00","updated_at":"2025-12-18T17:01:07.271874-05:00","closed_at":"2025-12-18T17:01:07.271874-05:00","comments":[{"id":5,"issue_id":"apex-mage-evq","author":"kev","text":"Starting implementation. Plan review complete.","created_at":"2025-12-18T21:59:39Z"},{"id":6,"issue_id":"apex-mage-evq","author":"kev","text":"Completed: Fix compress_image upscaling bug\n- Files changed: src/core/image_utils.py, tests/unit/test_image_utils.py\n- Approach: Added 1.0 cap to min() ratio calculation to prevent upscaling\n- Added test_does_not_upscale_small_images test\n- All 359 tests pass, ruff check passes\n- Commit: 32ce7a7","created_at":"2025-12-18T22:00:50Z"},{"id":7,"issue_id":"apex-mage-evq","author":"kev","text":"Implementation complete. All acceptance criteria met. Ready for review.","created_at":"2025-12-18T22:01:07Z"}]}
{"id":"apex-mage-f2l","title":"Add health check endpoint","description":"Create a /health endpoint that verifies connectivity to all external services (Anthropic, Fal.AI, GCS, database). Return structured status for monitoring systems.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:02.748382-05:00","updated_at":"2025-12-15T11:04:21.701077-05:00","closed_at":"2025-12-15T11:04:21.701077-05:00"}
{"id":"apex-mage-fm8","title":"Fix API health endpoint status codes","description":"Health endpoints always return HTTP 200 even when services are unhealthy.\nFix src/api/routes/health.py to return 503 when report.status != HEALTHY:\n```python\nfrom fastapi import Response\n\n@router.get('/health')\nasync def health_check(request: Request, response: Response):\n    report = await health_checker.check_all()\n    response.status_code = 200 if report.status == ServiceStatus.HEALTHY else 503\n    return report.to_dict()\n```\nAddresses: C7-1","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:50.611502-05:00","updated_at":"2025-12-18T16:18:50.611502-05:00"}
{"id":"apex-mage-h1z","title":"Consolidate rate limiting - remove mem.py duplicates","description":"Remove mem.enforce_image_rate_limits() and mem.enforce_text_rate_limits(). Update all callers to use src/core/rate_limit.py SlidingWindowRateLimiter instead.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.593392-05:00","updated_at":"2025-12-15T10:37:42.093535-05:00","closed_at":"2025-12-15T10:37:42.093535-05:00"}
{"id":"apex-mage-hgh","title":"2.7 Integrate providers into main.py","description":"## Current State\nmain.py imports ai.py functions directly.\n\n## Implementation Steps\n1. Update application bootstrap:\n   ```python\n   async def create_app():\n       repo = SQLiteMessageRepository(DB_PATH)\n       ai_provider = AnthropicProvider(os.environ[\"ANTHROPIC_API_KEY\"])\n       image_provider = FalAIProvider(os.environ[\"FAL_KEY\"])\n       \n       bot = create_bot(\n           repository=repo,\n           ai_provider=ai_provider,\n           image_provider=image_provider,\n       )\n       return bot\n   ```\n\n2. Update command handlers to use injected providers\n\n3. Remove direct ai.py imports from handlers\n\n4. Verify all AI/image commands work correctly\n\n## Acceptance Criteria\n- [ ] Providers are injected, not imported globally\n- [ ] All AI commands work with new providers\n- [ ] All image commands work with new providers\n- [ ] Easy to swap providers for testing","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:41.572436-05:00","updated_at":"2025-12-15T01:18:32.981775-05:00","closed_at":"2025-12-15T01:18:32.981775-05:00","dependencies":[{"issue_id":"apex-mage-hgh","depends_on_id":"apex-mage-1w4","type":"blocks","created_at":"2025-12-14T22:56:33.646134-05:00","created_by":"daemon"},{"issue_id":"apex-mage-hgh","depends_on_id":"apex-mage-7il","type":"blocks","created_at":"2025-12-14T22:56:33.688188-05:00","created_by":"daemon"}]}
{"id":"apex-mage-j4k","title":"4.0 CI/CD Pipeline Epic","description":"## Overview\nEstablish continuous integration pipeline for automated quality gates.\n\n## Goals\n- GitHub Actions workflow for PR checks\n- Automated linting (ruff)\n- Automated type checking (mypy)\n- Automated test execution with coverage\n\n## Acceptance Criteria\n- [ ] GitHub Actions workflow file created\n- [ ] Lint step runs ruff\n- [ ] Type check step runs mypy\n- [ ] Test step runs pytest with coverage\n- [ ] Pipeline blocks PRs on failure","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-14T22:52:41.300519-05:00","updated_at":"2025-12-15T01:43:48.750565-05:00","closed_at":"2025-12-15T01:43:48.750565-05:00"}
{"id":"apex-mage-jrs","title":"Create FastAPI service structure","description":"Set up FastAPI app in src/api/ with proper project structure, CORS configuration, dependency injection for providers/repositories, and Uvicorn entrypoint.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:11:13.070344-05:00","updated_at":"2025-12-15T11:12:37.708931-05:00","closed_at":"2025-12-15T11:12:37.708931-05:00","dependencies":[{"issue_id":"apex-mage-jrs","depends_on_id":"apex-mage-aca","type":"blocks","created_at":"2025-12-15T02:12:37.100384-05:00","created_by":"daemon"}]}
{"id":"apex-mage-lvg","title":"Migrate GCS upload to src/adapters/gcs_adapter.py","description":"Move upload_response_to_cloud() from ai.py to a new GCS adapter. Add proper error handling (don't silently fail), structured logging, and tests with mocked GCS client.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.306169-05:00","updated_at":"2025-12-15T02:42:54.475533-05:00","closed_at":"2025-12-15T02:42:54.475533-05:00"}
{"id":"apex-mage-mc4","title":"Update Discord commands to use AnthropicProvider","description":"Replace ai.prompt() calls in Discord commands with AnthropicProvider.chat(). Ensure dependency injection is wired correctly through DiscordBot.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.449061-05:00","updated_at":"2025-12-15T02:46:25.756478-05:00","closed_at":"2025-12-15T02:46:25.756478-05:00"}
{"id":"apex-mage-mj7","title":"4.3 Add mypy configuration","description":"## Current State\nNo type checking configuration.\n\n## Implementation Steps\n1. Add mypy configuration to `pyproject.toml`:\n   ```toml\n   [tool.mypy]\n   python_version = \"3.11\"\n   strict = true\n   warn_return_any = true\n   warn_unused_ignores = true\n   \n   [[tool.mypy.overrides]]\n   module = [\"discord.*\", \"fal_client.*\"]\n   ignore_missing_imports = true\n   ```\n\n2. Add type stubs for dependencies:\n   - anthropic has types\n   - discord.py has types\n   - May need stubs for fal_client\n\n3. Add `py.typed` marker to src/ if creating a package\n\n4. Fix type errors incrementally (may need follow-up tasks)\n\n## Acceptance Criteria\n- [ ] Mypy configuration in pyproject.toml\n- [ ] New code passes mypy strict\n- [ ] Third-party ignores configured where needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:59.058302-05:00","updated_at":"2025-12-15T01:23:22.946756-05:00","closed_at":"2025-12-15T01:23:22.946756-05:00"}
{"id":"apex-mage-n7n","title":"2.1 Create AIProvider Protocol","description":"## Current State\nai.py has Anthropic integration as module-level functions.\n\n## Implementation Steps\n1. Create `src/core/providers.py`\n\n2. Define AIProvider Protocol:\n   ```python\n   from typing import Protocol, AsyncIterator\n   from dataclasses import dataclass\n   \n   @dataclass\n   class ChatMessage:\n       role: str  # \"user\" | \"assistant\" | \"system\"\n       content: str\n   \n   @dataclass\n   class ChatResponse:\n       content: str\n       model: str\n       usage: dict[str, int]  # tokens\n   \n   class AIProvider(Protocol):\n       async def chat(\n           self,\n           messages: list[ChatMessage],\n           system_prompt: str | None = None,\n           max_tokens: int = 4096,\n       ) -\u003e ChatResponse: ...\n       \n       async def chat_stream(\n           self,\n           messages: list[ChatMessage],\n           system_prompt: str | None = None,\n       ) -\u003e AsyncIterator[str]: ...\n   ```\n\n3. Ensure protocol captures all AI operations from ai.py\n\n## Acceptance Criteria\n- [ ] Protocol defined with chat and streaming methods\n- [ ] Request/response dataclasses defined\n- [ ] No vendor-specific types in protocol\n- [ ] Docstrings explain method contracts","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:40.743041-05:00","updated_at":"2025-12-14T23:49:44.356273-05:00","closed_at":"2025-12-14T23:49:44.356273-05:00"}
{"id":"apex-mage-o50","title":"4.2 Add ruff configuration","description":"## Current State\nNo linter configuration.\n\n## Implementation Steps\n1. Add ruff configuration to `pyproject.toml`:\n   ```toml\n   [tool.ruff]\n   target-version = \"py311\"\n   line-length = 100\n   \n   [tool.ruff.lint]\n   select = [\n       \"E\",    # pycodestyle errors\n       \"W\",    # pycodestyle warnings\n       \"F\",    # pyflakes\n       \"I\",    # isort\n       \"B\",    # flake8-bugbear\n       \"C4\",   # flake8-comprehensions\n       \"UP\",   # pyupgrade\n   ]\n   ignore = [\"E501\"]  # line too long (handled by formatter)\n   \n   [tool.ruff.lint.isort]\n   known-first-party = [\"src\"]\n   ```\n\n2. Fix any existing lint errors in codebase\n\n3. Add ruff to dev dependencies\n\n## Acceptance Criteria\n- [ ] Ruff configuration in pyproject.toml\n- [ ] Codebase passes ruff check\n- [ ] Import sorting configured","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:58.917812-05:00","updated_at":"2025-12-15T01:20:28.041646-05:00","closed_at":"2025-12-15T01:20:28.041646-05:00"}
{"id":"apex-mage-oyt","title":"1.2 Create MessageRepository Protocol","description":"## Current State\nmem.py has functions for database operations but no formal interface.\n\n## Implementation Steps\n1. Create `src/core/protocols.py` (or `src/core/repositories.py`)\n\n2. Define MessageRepository Protocol:\n   ```python\n   from typing import Protocol, Optional\n   from dataclasses import dataclass\n   \n   @dataclass\n   class Message:\n       id: int\n       channel_id: int\n       user_id: int\n       content: str\n       role: str\n       timestamp: datetime\n   \n   class MessageRepository(Protocol):\n       async def save_message(self, msg: Message) -\u003e int: ...\n       async def get_context(self, channel_id: int, limit: int) -\u003e list[Message]: ...\n       async def get_user_messages(self, user_id: int, limit: int) -\u003e list[Message]: ...\n       # Add other methods based on mem.py analysis\n   ```\n\n3. Review mem.py to ensure all necessary operations are captured in the protocol\n\n## Acceptance Criteria\n- [ ] Protocol defined with all necessary methods\n- [ ] Message dataclass defined with proper types\n- [ ] Protocol is platform-agnostic (no Discord types)\n- [ ] Docstrings explain each method's contract","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:53:08.234746-05:00","updated_at":"2025-12-14T23:04:19.382944-05:00","closed_at":"2025-12-14T23:04:19.382944-05:00","dependencies":[{"issue_id":"apex-mage-oyt","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:29.906753-05:00","created_by":"daemon"}]}
{"id":"apex-mage-p2k","title":"3.3 Add core logic unit tests","description":"## Current State\nCore business logic extracted but untested.\n\n## Implementation Steps\n1. Create `tests/unit/test_conversation.py`:\n   - Test context windowing respects message limit\n   - Test context windowing respects token limit\n   - Test message formatting\n   - Test empty history handling\n\n2. Create `tests/unit/test_rate_limit.py`:\n   - Test rate limit allows within limit\n   - Test rate limit blocks over limit\n   - Test sliding window behavior\n   - Test different action types\n\n3. These tests should be fast (no I/O):\n   ```python\n   def test_context_windows_to_max_messages():\n       builder = ContextBuilder(max_messages=10)\n       history = [make_message(i) for i in range(20)]\n       context = builder.build_context(history)\n       assert len(context.messages) == 10\n   ```\n\n## Acceptance Criteria\n- [ ] Conversation logic tests complete\n- [ ] Rate limiting tests complete\n- [ ] All tests are fast (\u003c 100ms each)\n- [ ] \u003e80% coverage on core module","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:27.68067-05:00","updated_at":"2025-12-15T01:27:45.310251-05:00","closed_at":"2025-12-15T01:27:45.310251-05:00","dependencies":[{"issue_id":"apex-mage-p2k","depends_on_id":"apex-mage-c5n","type":"blocks","created_at":"2025-12-14T22:56:36.813656-05:00","created_by":"daemon"},{"issue_id":"apex-mage-p2k","depends_on_id":"apex-mage-rr4","type":"blocks","created_at":"2025-12-14T22:56:36.859822-05:00","created_by":"daemon"},{"issue_id":"apex-mage-p2k","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:36.903483-05:00","created_by":"daemon"}]}
{"id":"apex-mage-pcr","title":"5.1 Extract command handler decorators","description":"## Current State\nCommand handlers have repetitive boilerplate (error handling, logging, rate limiting).\n\n## Implementation Steps\n1. Create `src/clients/discord/decorators.py`\n\n2. Create error handling decorator:\n   ```python\n   def handle_errors(func):\n       @functools.wraps(func)\n       async def wrapper(interaction: discord.Interaction, *args, **kwargs):\n           try:\n               return await func(interaction, *args, **kwargs)\n           except RateLimitError as e:\n               await interaction.response.send_message(str(e), ephemeral=True)\n           except Exception as e:\n               logger.exception(\"Command failed\")\n               await interaction.response.send_message(\n                   \"An error occurred\", ephemeral=True\n               )\n       return wrapper\n   ```\n\n3. Create logging decorator:\n   ```python\n   def log_command(func):\n       @functools.wraps(func)\n       async def wrapper(interaction: discord.Interaction, *args, **kwargs):\n           logger.info(f\"Command {func.__name__} invoked by {interaction.user.id}\")\n           result = await func(interaction, *args, **kwargs)\n           logger.info(f\"Command {func.__name__} completed\")\n           return result\n       return wrapper\n   ```\n\n4. Apply decorators to existing commands\n\n## Acceptance Criteria\n- [ ] Error handling decorator created\n- [ ] Logging decorator created\n- [ ] Decorators applied to commands\n- [ ] Boilerplate reduced in handlers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:59.196402-05:00","updated_at":"2025-12-15T01:35:47.20221-05:00","closed_at":"2025-12-15T01:35:47.20221-05:00","dependencies":[{"issue_id":"apex-mage-pcr","depends_on_id":"apex-mage-35a","type":"blocks","created_at":"2025-12-14T22:56:44.021929-05:00","created_by":"daemon"}]}
{"id":"apex-mage-qv1","title":"Persist API keys to database","description":"API keys stored in module-level dict (_API_KEYS) are lost on restart and don't work with multiple workers.\nFix:\n1. Create API key table in database schema\n2. Add ApiKeyRepository protocol and implementation\n3. Update auth.py to use repository for API key storage/lookup\n4. Log warning at startup if running without persistent storage\nAddresses: C8-2","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:51.360238-05:00","updated_at":"2025-12-18T16:18:51.360238-05:00"}
{"id":"apex-mage-rr4","title":"3.2 Extract rate limiting logic","description":"## Current State\nRate limiting logic is in mem.py, coupled to database.\n\n## Implementation Steps\n1. Create `src/core/rate_limit.py`\n\n2. Define RateLimiter interface:\n   ```python\n   @dataclass\n   class RateLimitResult:\n       allowed: bool\n       remaining: int\n       reset_at: datetime\n       wait_seconds: float | None = None\n   \n   class RateLimiter(Protocol):\n       async def check(self, user_id: int, action: str) -\u003e RateLimitResult: ...\n       async def record(self, user_id: int, action: str) -\u003e None: ...\n   ```\n\n3. Implement sliding window rate limiter:\n   ```python\n   class SlidingWindowRateLimiter:\n       def __init__(self, storage: RateLimitStorage, limits: dict[str, RateLimit]):\n           ...\n   ```\n\n4. Create in-memory storage for testing:\n   ```python\n   class InMemoryRateLimitStorage:\n       ...\n   ```\n\n## Acceptance Criteria\n- [ ] Rate limiter protocol defined\n- [ ] Sliding window implementation\n- [ ] Storage is pluggable (in-memory, database)\n- [ ] Supports different limits per action type","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:55:02.852348-05:00","updated_at":"2025-12-15T01:20:27.713524-05:00","closed_at":"2025-12-15T01:20:27.713524-05:00"}
{"id":"apex-mage-svd","title":"Fix CI quality gate - resolve mypy and ruff errors","description":"CI pipeline would fail with 134 mypy errors and 52 ruff errors. Fix:\n1. Add ruff\u003e=0.8 to requirements.txt\n2. Add B008 to ruff ignore list (FastAPI pattern)\n3. Expand mypy overrides for structlog, jwt, fastapi, google\n4. Run ruff check --fix to auto-fix 24 issues\n5. Fix remaining lint/type issues\n6. Add pip caching to CI\n7. Cover root files (main.py, api_main.py)\nAddresses: C4-1 (Critical), C4-2, C4-3, C4-4, C4-5, C4-6, C4-7\n\n---\n## Implementation Summary (added by coding agent)\n\n### What Was Built\nFixed CI quality gate by resolving all ruff linting errors and configuring mypy to ignore missing type stubs for third-party libraries.\n\n### Files Changed\n- `requirements.txt` - Added ruff\u003e=0.8 under new Linting section\n- `pyproject.toml` - Added B008 to ruff ignore, expanded mypy overrides for 6 libraries\n- `.github/workflows/ci.yml` - Added pip caching, extended lint/typecheck to root files\n- `src/api/auth.py` - Added exception chaining (from ex) to satisfy B904\n- `src/api/routes/images.py` - Added exception chaining for HTTPException raises\n- `src/clients/discord/bot.py` - Moved logger declaration after imports to fix E402\n- `src/clients/discord/commands/chat.py` - Removed unused variable assignment\n- `src/core/errors.py` - Removed unused variable, added exception chaining\n- `src/core/health.py` - Added strict=True to zip() call\n- Various src/api/ files - Auto-fixed import ordering, datetime.UTC usage, type hints\n\n### Key Decisions\n- Used B008 ignore instead of refactoring FastAPI Depends() - this is the idiomatic pattern\n- Added module-level ignores for mypy rather than adding type stubs - libraries lack official stubs\n- Used exception chaining (from ex) to preserve stack traces while satisfying linter\n\n### Deviations from Plan\n- Fixed 50 errors total (not 52 as estimated) - some were duplicates or consolidated\n- Auto-fix resolved 36 issues (not 24 as estimated) - more were automatically fixable\n\n### Testing\n- All 358 existing tests pass\n- ruff check src/ main.py api_main.py returns 0 errors\n\n### Notes for Reviewer\n- mypy errors from missing type stubs are now suppressed via ignore_missing_imports\n- The actual type checking logic is unchanged - only import errors are suppressed\n- CI will now properly fail on real linting issues","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:49.729465-05:00","updated_at":"2025-12-18T16:54:24.969912-05:00","closed_at":"2025-12-18T16:54:24.969912-05:00","labels":["reviewed:approved"],"comments":[{"id":1,"issue_id":"apex-mage-svd","author":"kev","text":"Starting implementation. Plan review complete. Will fix CI quality gate by adding ruff, fixing configs, and auto-fixing lint issues.","created_at":"2025-12-18T21:51:00Z"},{"id":2,"issue_id":"apex-mage-svd","author":"kev","text":"Implementation complete:\n- Added ruff\u003e=0.8 to requirements.txt\n- Added B008 to ruff ignore list in pyproject.toml\n- Expanded mypy overrides for structlog, jwt, fastapi, google, uvicorn, aiohttp\n- Fixed 50 ruff errors (36 auto-fixed, 14 manual)\n- Updated CI workflow with pip caching and root file coverage\n- All 358 tests pass, ruff check passes\n- Commit: 7081c40","created_at":"2025-12-18T21:54:02Z"},{"id":3,"issue_id":"apex-mage-svd","author":"kev","text":"Implementation complete. All acceptance criteria met. Ready for review.","created_at":"2025-12-18T21:54:24Z"},{"id":4,"issue_id":"apex-mage-svd","author":"kev","text":"Review complete: APPROVED\n\nConfiguration changes:\n- requirements.txt: ruff\u003e=0.8 added correctly\n- pyproject.toml: B008 ignore and mypy overrides correct\n- CI workflow: pip caching and root file coverage added\n\nLint fixes verified:\n- B904 exception chaining: All 6 fixes use correct 'from e/ex' syntax\n- E402 import order: Logger moved after imports in bot.py\n- F841 unused variables: Correctly removed in errors.py\n- B905 strict zip: strict=True added in health.py\n- Auto-fixes: datetime.UTC and typing imports are correct\n\nMinor observation (not blocking):\n- chat.py:422-425 has a misleading comment claiming get_visible_messages 'triggers DB update' - it's actually a read operation. This is pre-existing dead code from a previous refactor. Consider removing the entire call in a future cleanup, but not required for this bead.\n\nAll acceptance criteria met. Tests reported passing (358). Good implementation.","created_at":"2025-12-18T21:58:51Z"}]}
{"id":"apex-mage-t79","title":"Add WebSocket endpoint integration tests","description":"WebSocket route handlers (conversation_websocket, global_websocket) are not tested.\nTests exist for ConnectionManager but not the actual endpoints.\nAdd tests for:\n1. Authentication (valid token, invalid token, no token)\n2. Message handling (ping/pong, typing indicators)\n3. Error handling (invalid JSON, disconnection)\nUse FastAPI TestClient WebSocket support.\nAddresses: C8-5","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:18:51.181761-05:00","updated_at":"2025-12-18T16:18:51.181761-05:00"}
{"id":"apex-mage-tqe","title":"2.6 Add provider unit tests","description":"## Current State\nProvider implementations exist but are untested.\n\n## Implementation Steps\n1. Create `tests/unit/test_anthropic_provider.py`:\n   - Test request formatting\n   - Test response parsing\n   - Test error handling (mock API errors)\n\n2. Create `tests/unit/test_fal_provider.py`:\n   - Test request formatting\n   - Test response parsing\n   - Test error handling\n\n3. Use httpx mock or similar to mock HTTP calls:\n   ```python\n   @pytest.fixture\n   def mock_anthropic_api(httpx_mock):\n       httpx_mock.add_response(\n           url=\"https://api.anthropic.com/v1/messages\",\n           json={...}\n       )\n   ```\n\n## Acceptance Criteria\n- [ ] Unit tests for AnthropicProvider\n- [ ] Unit tests for FalAIProvider\n- [ ] Tests mock HTTP layer, not actual APIs\n- [ ] Error scenarios tested","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:54:41.436297-05:00","updated_at":"2025-12-15T01:04:31.389859-05:00","closed_at":"2025-12-15T01:04:31.389859-05:00","dependencies":[{"issue_id":"apex-mage-tqe","depends_on_id":"apex-mage-1w4","type":"blocks","created_at":"2025-12-14T22:56:33.514132-05:00","created_by":"daemon"},{"issue_id":"apex-mage-tqe","depends_on_id":"apex-mage-7il","type":"blocks","created_at":"2025-12-14T22:56:33.558131-05:00","created_by":"daemon"},{"issue_id":"apex-mage-tqe","depends_on_id":"apex-mage-act","type":"blocks","created_at":"2025-12-14T22:56:33.601365-05:00","created_by":"daemon"}]}
{"id":"apex-mage-vx5","title":"1.3 Implement SQLiteMessageRepository","description":"## Current State\nmem.py contains SQLite operations as module-level functions with global connection.\n\n## Implementation Steps\n1. Create `src/db/sqlite_repository.py`\n\n2. Implement SQLiteMessageRepository class:\n   ```python\n   class SQLiteMessageRepository:\n       def __init__(self, db_path: str | Path):\n           self._db_path = db_path\n           self._connection: Optional[sqlite3.Connection] = None\n       \n       async def connect(self) -\u003e None: ...\n       async def close(self) -\u003e None: ...\n       \n       # Implement all Protocol methods\n   ```\n\n3. Migrate existing SQL from mem.py:\n   - Preserve existing query logic\n   - Use parameterized queries (already should be)\n   - Add proper error handling\n\n4. Support async context manager for connection lifecycle\n\n## Acceptance Criteria\n- [ ] Class implements MessageRepository Protocol\n- [ ] Connection is injected, not global\n- [ ] All existing mem.py operations are supported\n- [ ] Proper resource cleanup (context manager)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T22:53:08.36867-05:00","updated_at":"2025-12-14T23:09:02.700461-05:00","closed_at":"2025-12-14T23:09:02.700461-05:00","dependencies":[{"issue_id":"apex-mage-vx5","depends_on_id":"apex-mage-oyt","type":"blocks","created_at":"2025-12-14T22:56:29.953785-05:00","created_by":"daemon"}]}
{"id":"apex-mage-wto","title":"Migrate image utilities to src/core/image_utils.py","description":"Move image_strip_headers(), compress_image(), and format_image_response() from ai.py to a new src/core/image_utils.py module with proper typing and tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T02:10:51.161626-05:00","updated_at":"2025-12-15T02:42:54.474987-05:00","closed_at":"2025-12-15T02:42:54.474987-05:00"}
